<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="format-detection" content="telephone=no">
    <title>我咨询的老师</title>
    <link rel="stylesheet" href="../css/frozen.css">
    <link rel="stylesheet" href="../css/public.css">
    <script src="../lib/zepto.min.js"></script>
    <script src="../js/frozen.js"></script>
    <style type="text/css">
    .ui-tab-content {margin-top: 0;}
    
    .demo-block .ui-list{background: #f6f6f6;}
    .demo-block .ui-list li{background: #fff;margin-left: 0;padding: 10px 10px 10px 15px;border-bottom: 1px solid #e0e0e0;}
    
    .ui-list .ui-list-info h4{color: #585858;font-size: 14px;}
    .ui-list-info .ui-teacher-info{margin-top:5px;}
    .ui-list-info .ui-teacher-name{color:#a7a4a4;font-size: 12px;}
    .ui-list-info .ui-teacher-title{color:#a7a4a4;font-size: 12px;margin-left:5px;}
    
    .ui-btn-sure .ui-teleph{margin-top:40px;}
    .item-passed .ui-list li{margin-left:0;}
    .item-passed .ui-avatar{margin: 20px 10px 20px 10px;height: 60px;width: 60px;}
    .item-passed h4{height:30px;color:#585858;}
    .pad16{padding-left:16px;}
    .btn-r{color: #fff;border-radius: 11px;padding: 4px 10px;float: right;background-color:#f66161;}
    .btn-r.btn-rb{background-color:#18b4ed;margin-right: 8px;}

    .demo-block .ui-list .ui-nomsg{margin-left: 0;border: none;height: 400px;z-index: 0;}
    .ui-label{height: 20px;line-height: 20px;float: right;color: #fff;}
    .ui-label-cancel{background-color: #f66161;}
    .ui-label-success{background-color: #53bcf9;}
    </style>
</head>

<body ontouchstart>
    <header class="ui-header ui-header-positive ui-border-b">
        <h1>我咨询的老师</h1>
    </header>
    <section class="ui-container">
        <div class="demo-block">
            <div class="ui-tab">
                <ul class="ui-tab-nav ui-border-b">
                    <li class="current">进行中</li>
                    <li>已结束</li>
                </ul>
                <ul class="ui-tab-content" style="width:200%">
                    <li>
                        <div class="demo-block ui-myteacher">
                            <ul class="ui-list ui-border-tb">
                                <!-- <li>
                                    <div class="ui-avatar">
                                        <span style="background-image:url(http://placeholder.qiniudn.com/100x100)"></span>
                                    </div>
                                    <div class="ui-list-info">
                                        <h4 class="ui-nowrap">远程：高数老不回怎么办，点击看看</h4>
                                        <p class="ui-nowrap ui-teacher-name">OIHIOD</p>
                                        <p class="ui-nowrap"><span>北京大学博士</span><button class="btn-r">取消</button><button class="btn-r btn-rb">确定</button></p>
                                    </div>
                                </li> -->
                            </ul>
                            <!-- 下拉加载提示 -->
                            <div class="ui-loading-wrap" style="display:none;">
                                <p>下拉加载</p>
                                <i class="ui-loading" style="display:none;"></i>
                            </div>
                        </div>
                    </li>
                    <li class="item-passed">
                        <div class="demo-block ui-item-list">
                            <ul class="ui-list"></ul>
                            <!-- 下拉加载提示 -->
                            <div class="ui-loading-wrap" style="display:none;">
                                <p>下拉加载</p>
                                <i class="ui-loading" style="display:none;"></i>
                            </div>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </section>
    <!-- /.ui-container-->
    <script>
   
    $('.ui-list li,.ui-tiled li').click(function() {
        if ($(this).data('href')) {
            location.href = $(this).data('href');
        }
    });

    var params = {'finish':false,page:0,size:10};
    var currIndex = 0;

    Zepto(function($) {

        var tab = new fz.Scroll('.ui-tab', {
            role: 'tab',
            autoplay: false,
            interval: 3000
        });
        tab.on('beforeScrollStart', function(from, to) {
            $('.ui-list').eq(to).empty();
        });
        tab.on('scrollEnd', function(curPage) {
            // curPage 当前页
            currIndex = curPage;
            params.finish = currIndex==0?false:true;
            initReq(true,true);
        });
        initReq(true,true);

    });

    function _dealList(dealList,isRefresh){
        //state 有INIT(进行中) FINISH（完成） 和 CANCEL（取消）
        if(isRefresh){
            $('.ui-list').eq(currIndex).empty();    
        }
        var str = "";
        if(dealList.length>0){
            for (var i = 0; i < dealList.length; i++) {
                var dealObj = dealList[i];
                str += '<li id="'+dealObj.id+'"><div class="ui-avatar"><span style="background-image:url('+dealObj.teacherImage+')"></span></div>';
                str += '<div class="ui-list-info"><h4 class="ui-nowrap">'+dealObj.productName+'</h4>';
                str += '<p class="ui-nowrap ui-teacher-info"><span class="ui-teacher-name">'+dealObj.teacherName+'</span>';
                str += '<span class="ui-teacher-title">'+dealObj.teacherTitle+'</span>';
                if(currIndex==1){
                    str += '<label class="ui-label '+(dealObj.state=='CANCEL'?'ui-label-cancel':'ui-label-success')+'">'+(dealObj.state=='CANCEL'?'已取消':'已完成')+'</label>';
                }
                str += '</p></div></li>';
            };
            
            $('.ui-list').eq(currIndex).append(str);
            $('.ui-list').on('click','li',function(){
                 location.href = "lessonProduct.html?id="+$(this).attr('id');
            });

        }else{
            $('.ui-list').eq(currIndex).append('<li class="ui-nomsg"><section class="ui-notice"><i></i><p>暂无预约信息</p></section></li>');
        }
        
    }
    function initReq(flag,isRefresh){
        $(window).unbind('scroll');
        if(!flag){
            params.page = pageNum;
            _dealLoading('loading');
        }else{
            BWK.Utils.loading.show();
            pageNum = 0;
            params.page = 0;
        }   

        BWK.api.user.userOrderList(params,function(data){
            var dealObj = data.content||[]; 
            if(flag){
                BWK.Utils.loading.hide();
            }
            _dealList(dealObj,isRefresh);
            if(data.totalPages<2){
                $('.ui-loading-wrap').hide();
            }else{
                if(data.totalPages == data.number+1){
                    _dealLoading('end');
                }else{
                    _dealLoading('start');
                    $(window).bind('scroll',function () { dealPullReq(); });
                }
                
            }
        }); 

    }
    function dealPullReq(){
        var scrollTop = document.body.scrollTop;//滚轮高度
        var windowHeight = $(window).height();  //浏览器显示区域高度
        var wholeHeight=document.body.scrollHeight;
        if (scrollTop + windowHeight == wholeHeight) {
            //加载条
            pageNum += 1;                   
            initReq(false);  
        }
    }
    function _dealLoading(type){
        $('.ui-loading-wrap').hide();
        $('.ui-loading-wrap').eq(currIndex).show();
        if(type=='start'){
            $('.ui-loading-wrap p').text('下拉刷新');
            $('.ui-loading-wrap .ui-loading').hide();
        }else if(type=="end"){
            $('.ui-loading-wrap p').text('亲！已经到底了');
            //$('.ui-loading-wrap p').addClass('nomore');
            $('.ui-loading-wrap .ui-loading').hide();
        }else if(type="loading"){
            $('.ui-loading-wrap p').text('正在加载中。。。');
            $('.ui-loading-wrap .ui-loading').show();
        }   
    }

    
    </script>
</body>

</html>
